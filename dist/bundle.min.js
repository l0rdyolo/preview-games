class Entity{constructor(t,i){this.position=t,this.basePosition=this.position.copy(),this.size=i.size,this.color=i.color,this.isCollected=!1,this._active=!0}set active(t){this._active=t}get active(){return this._active}move(t){this.position.z+=t}checkCollision(t){this.isCollected||p5.Vector.dist(this.position,t.position)<10&&this.hit()}reset(){this.position.z=this.basePosition.z-1e3,this.isCollected=!1,this.active=!0}hit(){this.isCollected=!0,this.active=!1}}class Obstacle extends Entity{constructor(t,i){super(t,i),this.grid=[],this.gridSize=3,this.animationSpeed=.2,this.initializeGrid()}initializeGrid(){var e=this.size/this.gridSize;for(let i=0;i<this.gridSize;i++){var s=[];for(let t=0;t<this.gridSize;t++){var o={x:i*e,z:t*e,size:random(e/2,1.5*e),targetSize:random(e/2,1.5*e)};s.push(o)}this.grid.push(s)}}draw(){if(this.updateGrid(),push(),translate(this.position.x,0,this.position.z),this.active)for(let i=0;i<this.gridSize;i++)for(let t=0;t<this.gridSize;t++){var e=this.grid[i][t];push(),translate(e.x,0,e.z),this.active&&(fill(this.color),box(this.size,e.size,this.size)),pop()}pop()}updateGrid(){for(let i=0;i<this.gridSize;i++)for(let t=0;t<this.gridSize;t++){var e=this.grid[i][t];e.size=lerp(e.size,e.targetSize,this.animationSpeed),abs(e.size-e.targetSize)<.1&&(e.targetSize=random(this.size/2,1.5*this.size))}}hit(){super.hit(),noLoop(),gameMusic.stop()}}class Collectable extends Entity{constructor(t,i){super(t,i)}draw(){push(),translate(this.position.x,0,this.position.z),this.active&&(fill(this.color),noStroke(),box(this.size,this.size,this.size)),pop()}hit(){super.hit(),score+=10}}class Building{constructor(t,i,e,s){this.x=t,this.z=i,this.height=e,this.width=s,this.color=color(20,0,random(50,255)),this.windowRows=floor(random(3,6)),this.windowCols=floor(random(2,4)),this.windows=this.createWindows()}createWindows(){var i=[];for(let t=0;t<this.windowRows;t++){var e=[];for(let t=0;t<this.windowCols;t++){var s=.3<random();e.push(s)}i.push(e)}return i}draw(){push();var t=map(this.z,-3e3,500,.5,1.5),i=this.width*t,t=this.height*t,e=map(this.z,-3e3,500,50,255);fill(this.color.levels[0],this.color.levels[1],this.color.levels[2],e),translate(this.x,-t/2,this.z),noStroke(),box(i,t,i),this.drawWindows(i,t),pop()}drawWindows(e,s){var o=e/(this.windowCols+1),r=s/(this.windowRows+1);for(let i=0;i<this.windowRows;i++)for(let t=0;t<this.windowCols;t++){var a=-e/2+(t+1)*o,h=-s/2+(i+1)*r,n=this.windows[i][t];fill(n?color(255,255,0,200):color(50,50,50,100)),rect(a-o/2+5,h-r/2+5,o-10,r-10)}}move(t){this.z+=t,500<this.z&&this.resetPosition()}resetPosition(){this.z=-3e3,this.height=random(100,300),this.width=random(50,100),this.color=color(20,0,random(50,255)),this.windows=this.createWindows()}}class Platform{constructor(t,i,e,s){this.grid=t,this.gap=i,this.lanePositions=s,this.collectables=[],this.obstacles=[],this.entities=[],this.imposter=void 0,this.startZ=e,this.setup()}setup(){let e=this.startZ;for(let i=0;i<this.grid.length;i++){i%3==0&&0!==i&&(e+=200);for(let t=0;t<this.grid[i].length;t++){var s,o=this.lanePositions[t],o=createVector(o,0,e);1===this.grid[i][t]?(s=new Collectable(o,GameConfig.collectable),this.collectables.push(s),this.entities.push(s)):2===this.grid[i][t]&&(s=new Obstacle(o,GameConfig.obstacle),this.obstacles.push(s),this.entities.push(s)),0===i&&0===t&&(this.imposter=new Collectable(o,GameConfig.collectable),this.imposter.active=!1,this.entities.push(this.imposter))}e+=this.gap+45}}update(i,e){this.entities.forEach(t=>{t.move(i),t.checkCollision(e)}),this.imposter&&100<this.imposter.position.z&&this.resetEntities()}draw(){push(),this.entities.forEach(t=>{t.active&&t.draw()}),pop()}resetEntities(){this.entities.forEach(t=>{t.reset()}),this.imposter.active=!1,this.imposter.isCollected=!0}}class Player{constructor(t,i){this.lanePositions=i,this.currentLane=1,this.position=createVector(this.lanePositions[this.currentLane],0,20),this.width=t.width,this.height=t.height,this.depth=t.depth,this.targetX=this.position.x,this.lerpAmount=.1,this.collideDistance=4}draw(){this.position.x=lerp(this.position.x,this.targetX,this.lerpAmount),this.drawCar()}drawCar(){push(),translate(this.position.x,this.position.y,this.position.z),fill(250,255,250),noStroke(),box(this.width,this.height,this.depth),pop()}move(t){"left"===t&&0<this.currentLane?this.currentLane--:"right"===t&&this.currentLane<this.lanePositions.length-1&&this.currentLane++,this.targetX=this.lanePositions[this.currentLane]}collidesWith(t){return dist(this.position.x,this.position.y,this.position.z,t.position.x,t.position.y,t.position.z)<this.collideDistance}checkCollisions(t){t.forEach(t=>{this.collidesWith(t)&&!t._isCollided&&t.hit()})}hit(t){console.log("Player hit an entity!")}}class LaneLine{constructor(t,i,e,s=Color.DeepBlack.hex){this.positionX=t,this.depth=i,this.key=e,this.color=s,this.active=!1,this.colors=[Color.lineEffect.x1,Color.lineEffect.x2,Color.lineEffect.x3],this.currentColorIndex=0,this.blinkingInterval=null}draw(){strokeWeight(15),stroke(this.active?this.colors[this.currentColorIndex]:this.color),push(),translate(this.positionX,95,0),rotateX(HALF_PI),line(0,-this.depth/2,0,this.depth/2),pop()}activate(){this.active=!0,this.startBlinking()}deactivate(){this.active=!1,clearInterval(this.blinkingInterval),this.blinkingInterval=null,this.currentColorIndex=0}startBlinking(){this.blinkingInterval=setInterval(()=>{this.currentColorIndex=(this.currentColorIndex+1)%this.colors.length},300)}}class ParticleEffect{constructor(t,i,e){this.x=t,this.y=i,this.z=e,this.particles=[],this.lifetime=60;for(let t=0;t<10;t++)this.particles.push({x:this.x,y:this.y,z:this.z,xSpeed:random(-1,1),ySpeed:random(-1,1),zSpeed:random(-1,1)})}update(){this.lifetime--;for(var t of this.particles)t.x+=t.xSpeed,t.y+=t.ySpeed,t.z+=t.zSpeed}draw(){}isFinished(){return this.lifetime<=0}}class Environment{constructor(t,i,e){this.sky=t,this.terrain=i,this.ground=e}update(t){this.terrain.update(t)}display(t,i){this.sky.display(),this.terrain.display(i),this.ground.draw(t)}}class SoundManager{constructor(t,i,e){this.music=t,this.amplitude=new p5.Amplitude,this.setup(),this.peaks=[],this.peakAverage=0,this.calculatePeakAverage()}setup(){this.music.loop(),this.amplitude.smooth(.9)}calculatePeakAverage(){this.peaks=this.music.getPeaks(width);var t=this.peaks.reduce((t,i)=>t+i,0);this.peakAverage=t/this.peaks.length}getCurrentPeak(){return this.amplitude.getLevel()}update(t){this.getCurrentPeak()>this.peakAverage&&t.triggerFlashEffect()}}class PlatformManager{constructor(){this.platforms=[],this.setup()}setup(){for(let t=0;t<platformsPrefabs.length;t++){var i=t*(9*platformGap)-3e3,e=platformsPrefabs[t],e=new Platform(e,platformGap,i,lanePositions);this.platforms.push(e)}}draw(){this.platforms.forEach(t=>t.draw())}update(i,e){this.platforms.forEach(t=>t.update(i,e))}}class SpeedManager{constructor(t,i=5){this.sound=t,this.smoothingWindow=i,this.peaks=[],this.smoothedPeaks=[],this.speed=1}loadSound(){this.peaks=this.sound.getPeaks(width),this.smoothedPeaks=this.smoothPeaks(this.peaks)}smoothPeaks(e){var s=[];for(let t=0;t<e.length;t++){var o=max(0,t-this.smoothingWindow),r=min(e.length-1,t+this.smoothingWindow);let i=0;for(let t=o;t<=r;t++)i+=e[t];s.push(i/(r-o+1))}return s}getSmoothSpeed(){var t=this.sound.currentTime()/this.sound.duration(),t=floor(t*this.smoothedPeaks.length),t=map(this.smoothedPeaks[t],-1,1,1,20);return this.speed=lerp(this.speed,t,.1),this.speed}}class CameraManager{constructor(t){this.player=t,this.camera=createCamera(),this.mode="normal",this.cameraX=0}setMode(t){this.mode=t}update(){this.cameraX=lerp(this.cameraX,this.player.position.x,.1),"normal"===this.mode?this.setNormalCamera():"test"===this.mode&&this.setTestCamera()}setNormalCamera(){this.camera.setPosition(this.cameraX,-30,100),this.camera.lookAt(this.cameraX,-30,0)}setTestCamera(){this.camera.setPosition(this.cameraX,-200,100),this.camera.lookAt(this.cameraX,0,0)}}class Ground{constructor(t){this.width=t.width,this.length=t.length,this.laneCount=t.laneCount,this.stripeWidth=t.stripeWidth,this.colorPalette=new ColorPalette,this.localX=20,this.stripes=[],this.initializeStripes(),this.laneWidth=this.width/this.laneCount,this.lanePositions=this.calculateLanePositions()}calculateLanePositions(){var i=[],e=this.width/2;for(let t=0;t<this.laneCount;t++){var s=-e+t*this.laneWidth+this.laneWidth/2;i.push(20+s)}return i}initializeStripes(){for(let t=1;t<this.laneCount;t++){var i=-this.width/2+t*this.laneWidth;this.stripes.push(i)}}draw(i){push(),translate(this.localX,5,-1200);for(let t=0;t<this.laneCount;t++){push();var e=this.colorPalette.waveColor(30*t);t===i?fill(red(e),green(e),blue(e),.8):fill(red(e),green(e),blue(e),.2),noStroke(),translate(-this.width/2+t*this.laneWidth+this.laneWidth/2,0,this.length/2),rotateX(HALF_PI),plane(this.laneWidth,this.length),pop()}pop()}}class Sky{constructor(t){this.width=t.width,this.height=t.height,this.starCount=t.starCount,this.canvasSky=this.createSky()}createSky(){var i=createGraphics(this.width,this.height);i.noFill(),i.noStroke(),i.fill(255,255,255,random(100,255));for(let t=0;t<this.starCount;t++)i.ellipse(random(0,this.width),random(0,this.height),random(2,8));return i}display(){push(),translate(0,-400,-1500),noStroke(),texture(this.canvasSky),plane(3e3,2e3),pop()}}class Terrain{constructor(t){this.rows=t.rows,this.cols=t.cols,this.size=t.size,this.altitude=t.altitude,this.trench=t.trench,this.baseColor=color(...t.color),this.strokeColor=color(...t.strokeColor),this.strokeWeight=3,this.terrainMesh=[],this.flying=0,this.rowPosition=0,this.isFlashing=!1,this.flashStartTime=0,this.flashDuration=1e3,this.initializeTerrain()}initializeTerrain(){for(let i=0;i<this.rows;i++){var e=[];for(let t=0;t<this.cols;t++)e.push(this.renderTerrainPoint(t,i));this.terrainMesh.push(e)}}renderTerrainPoint(t,i){let e;return e=t===this.trench||t===this.trench+1?random(0,.2)*this.size:t===this.trench-1||t===this.trench+2?map(noise(t,i),0,1,0,.2)*this.altitude:noise(t,i)*this.altitude}update(t){if(this.flying+=t,this.flying>=this.size){this.flying=0,this.rowPosition++,this.terrainMesh.pop();var i=[];for(let t=0;t<this.cols;t++)i.push(this.renderTerrainPoint(t,this.rowPosition));this.terrainMesh.unshift(i)}this.isFlashing&&((t=millis()-this.flashStartTime)>this.flashDuration?(this.isFlashing=!1,this.strokeWeight=3):this.strokeWeight=map(sin(.05*t),-1,1,3,6))}display(){push(),rotateX(PI/2),translate(-220,-2400,-40),fill(this.baseColor),stroke(this.strokeColor),strokeWeight(this.strokeWeight);for(let i=0;i<this.rows-1;i++){beginShape(TRIANGLE_STRIP);for(let t=0;t<this.cols;t++)vertex(t*this.size,i*this.size+this.flying,this.terrainMesh[i][t]),vertex(t*this.size,(i+1)*this.size+this.flying,this.terrainMesh[i+1][t]);endShape()}pop()}triggerFlashEffect(){this.isFlashing||(this.isFlashing=!0,this.flashStartTime=millis())}}class ColorPalette{constructor(){this.hueOffset=0,this.hueSpeed=.1}hsvToRgb(e,s,o){var t=(t,i=(t+e/60)%6)=>o-o*s*Math.max(Math.min(i,4-i,1),0);return color(t(5),t(3),t(1))}waveColor(t,i=0){t=(this.hueOffset+t)%360;this.hueOffset+=this.hueSpeed;return this.hsvToRgb(t,1,1)}updateHueSpeed(t){this.hueSpeed=map(t,7,15,.1,.5)}}let Color={NeonPink:{hex:"#ff2a6d",rgb:"rgb(255,42,109)"},NeonBlue:{hex:"#05d9e8",rgb:"rgb(5,217,232)"},NeonPurple:{hex:"#8f00ff",rgb:"rgb(143,0,255)"},NeonGreen:{hex:"#39ff14",rgb:"rgb(57,255,20)"},DeepBlack:{hex:"#01012b",rgb:"rgb(1,1,43)"},lineEffect:{x1:"rgb(255, 0, 255)",x2:"rgb(0, 255, 255)",x3:"rgb(255, 255, 0)"}},platformsPrefabs=[[[0,1,0],[2,1,2],[0,1,0],[1,0,1],[0,2,0],[1,0,1],[0,2,0],[1,0,1],[2,1,2],[0,1,0],[2,1,2],[0,2,0],[1,0,1],[1,0,1],[1,0,1],[2,0,2]]],BASE_SPEED=3,MAX_SPEED=15,SPEED_ACC_RATE=.3,SPEED_DEC_RATE=.7,player,ground,terrain,environment,lanePositions,speedManager,soundManager,cameraManager,platformManager,gameMusic,gameSpeed=0,cameraX=0,score=0,platformGap=50,playButton;function preload(){gameMusic=loadSound(GameConfig.music.src)}function setup(){createCanvas(GameConfig.canvas.size,400,WEBGL),pixelDensity(GameConfig.canvas.pixelDensity),colorMode(RGB,255,255,255,1),soundManager=new SoundManager(gameMusic,BASE_SPEED,MAX_SPEED),(speedManager=new SpeedManager(gameMusic,10)).loadSound(),ground=new Ground(GameConfig.ground),lanePositions=ground.lanePositions,terrain=new Terrain(GameConfig.terrain),environment=new Environment(new Sky(GameConfig.sky),terrain,ground),player=new Player(GameConfig.player,lanePositions),platformManager=new PlatformManager(platformsPrefabs,platformGap,lanePositions),cameraManager=new CameraManager(player),gameSpeed=BASE_SPEED,(playButton=createButton("Pause")).position(10,450),playButton.mousePressed(togglePlay)}function draw(){background(0),cameraManager.update(),gameSpeed=speedManager.getSmoothSpeed(),soundManager.update(terrain),environment.update(gameSpeed),environment.display(player.currentLane),player.draw(),platformManager.draw(),platformManager.update(gameSpeed,player),updateStats(gameSpeed)}function keyPressed(){keyCode===LEFT_ARROW?player.move("left"):keyCode===RIGHT_ARROW&&player.move("right"),"c"===key&&("normal"===cameraManager.mode?cameraManager.setMode("test"):cameraManager.setMode("normal"))}function updateStats(t){document.getElementById("speedDisplay").innerHTML="Speed: "+t.toFixed(0),document.getElementById("fpsDisplay").innerHTML="FPS: "+frameRate().toFixed(0),document.getElementById("score").innerHTML="Score: "+score}function togglePlay(){gameMusic.isPlaying()?(gameMusic.pause(),playButton.html("Play")):(gameMusic.play(),playButton.html("Pause"))}